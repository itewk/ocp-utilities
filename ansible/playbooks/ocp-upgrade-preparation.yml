# Tasks that need to be completed before a OCP upgrade.
#
# REQUIRED VARIABLES
#   ocp_repository - Name of the OCP repository to enable for the upcoming upgrade
#
# EXAMPLE EXECUTIONS:
#   Prepare for Upgrade to OCP 3.2
#     > ansible-playbook ocp-upgrade-prereqs-playbook.yml --extra-vars "ocp_repository=rhel-7-server-ose-3.2-rpms"
#
#   Prepare for Upgrade to OCP 3.3
#     > ansible-playbook ocp-upgrade-prereqs-playbook.yml --extra-vars "ocp_repository=rhel-7-server-ose-3.3-rpms"
#
#   Prepare for Upgrade to OCP 3.4
#     > ansible-playbook ocp-upgrade-prereqs-playbook.yml --extra-vars "ocp_repository=rhel-7-server-ose-3.4-rpms"

- name: OCP Upgrade Prerequisites
  hosts: all
  user: root
  tasks:
    - name: Disable All Repositories
      command: "subscription-manager repos --disable='*'"

    - name: Enable Required Repositories
      command: "subscription-manager repos --enable='{{ item }}'"
      with_items: "{{ ocp_repositories }}"

    - name: Unexclude packages from update
      command: "{{ item }} unexclude"
      with_items:
        - atomic-openshift-excluder
        - atomic-openshift-docker-excluder

    - name: Clear the yum cache
      command: yum clean all

    - name: Update atomic-openshift packages required for Update or Upgrade
      yum:
        name: "{{ item }}"
        state: latest
      with_items:
        - atomic-openshift-utils
        - atomic-openshift-excluder
        - atomic-openshift-docker-excluder

    # This is needed because if the excluders update then they set exclusion again
    - name: Unexclude packages from update after excluder update
      command: "{{ item }} unexclude"
      with_items:
        - atomic-openshift-excluder
        - atomic-openshift-docker-excluder

- name: OCP Upgrade Optional Prerequisists - Masters
  hosts: masters
  user: root
  tasks:
   - name: Create examples directory
     file:
       path: /usr/share/openshift/examples
       owner: root
       group: root
       mode: u=rwX,go=rX
       state: directory
       recurse: true

   - name: Update examples
     synchronize:
       src: "/usr/share/ansible/openshift-ansible/roles/openshift_examples/files/examples/v{{ ocp_version }}"
       dest: /usr/share/openshift/examples
     delegate_to: "{{ inventory_hostname }}"
